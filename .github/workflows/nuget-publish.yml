name: Build, Publish

on:
  push:
    branches:
      - main
  pull_request:
    branches: [ main ]
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  BUILD_CONFIGURATION: 'Release'
  PROJECT_PATH: 'MAX.Bot/MAX.Bot.csproj'

jobs:
  # =================== –®–ê–ì 1: –°–ë–û–†–ö–ê –ò –°–û–ó–î–ê–ù–ò–ï –ü–ê–ö–ï–¢–ê ===================
  build-and-pack:
    name: Build and Create NuGet Package
    runs-on: ubuntu-latest
    
    outputs:
      package_version: ${{ steps.set_version.outputs.package_version }}
      package_name: ${{ steps.build.outputs.package_name }}
      package_file: ${{ steps.build.outputs.package_file }}
    
    steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Build project
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ${{ github.workspace }}/Examples/Releases/*.nupkg
        retention-days: 7

  # =================== –®–ê–ì 2: –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –í NUGET.ORG ===================
  publish-to-nuget:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: build-and-pack

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Debug NuGet configuration
      run: |
        echo "=== NUGET DEBUG INFORMATION ==="
        echo ""
        
        # –í–µ—Ä—Å–∏—è dotnet –∏ NuGet
        echo "1. .NET SDK Version:"
        dotnet --version
        echo ""
        
        # –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã NuGet
        echo "2. NuGet CLI info:"
        dotnet nuget --version
        echo ""
        
        # –¢–µ–∫—É—â–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
        echo "3. Current NuGet sources:"
        dotnet nuget list source
        echo ""
        
        # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
        echo "4. Global NuGet config:"
        cat ~/.nuget/NuGet/NuGet.Config 2>/dev/null || echo "No global config found"
        echo ""
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        echo "5. User NuGet config:"
        cat ~/.config/NuGet/NuGet.Config 2>/dev/null || echo "No user config found"
        echo ""
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        echo "6. Project NuGet config:"
        find . -name "nuget.config" -type f | head -3 | while read file; do
          echo "Found: $file"
          cat "$file"
          echo ""
        done
        echo ""
        
        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è NuGet
        echo "7. NuGet environment variables:"
        env | grep -i nuget || echo "No NuGet env vars found"
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        echo "8. Testing source connectivity:"
        dotnet nuget list source --format detailed
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
        echo "9. NuGet cache locations:"
        dotnet nuget locals all --list
        echo "======================"

    - name: Publish to NuGet.org
      run: |
        echo "Publishing packages to NuGet.org..."
        
        # –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç (–±–µ–∑ symbols)
        PACKAGE_FILE=$(ls *.nupkg | grep -v symbols | head -1)
        
        if [ -z "$PACKAGE_FILE" ]; then
          echo "ERROR: No package file found!"
          exit 1
        fi
        
        echo "Publishing: $PACKAGE_FILE"
        echo "Version: ${{ needs.build-and-pack.outputs.package_version }}"
        
        # –ü—É–±–ª–∏–∫—É–µ–º –ø–∞–∫–µ—Ç
        dotnet nuget push "$PACKAGE_FILE" \
          --source "https://api.nuget.org/v3/index.json" \
          --api-key "${{ secrets.NUGET_API_KEY }}" \
          --skip-duplicate \
          --timeout 300
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Successfully published to NuGet.org"
          echo "üì¶ Package URL: https://www.nuget.org/packages/${{ needs.build-and-pack.outputs.package_name }}/"
          
          # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ –≤ GitHub
          echo "Creating GitHub Release..."
        else
          echo "‚ùå Failed to publish to NuGet.org"
          exit 1
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        name: Release ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        generate_release_notes: true
        files: |
          *.nupkg