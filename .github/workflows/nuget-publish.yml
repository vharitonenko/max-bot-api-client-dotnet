name: Build, Publish

on:
  push:
    tags:
      - 'v*'  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–æ–≤ v1.0.0, v2.3.4 –∏ —Ç.–¥.
    branches:
      - main
  pull_request:
    branches: [ main ]
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  BUILD_CONFIGURATION: 'Release'
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'
  PROJECT_PATH: './MAX.Bot/MAX.Bot.csproj'

jobs:
  # =================== –®–ê–ì 1: –°–ë–û–†–ö–ê –ò –°–û–ó–î–ê–ù–ò–ï –ü–ê–ö–ï–¢–ê ===================
  build-and-pack:
    name: Build and Create NuGet Package
    runs-on: ubuntu-latest
    
    outputs:
      package_version: ${{ steps.set_version.outputs.package_version }}
      package_name: ${{ steps.build.outputs.package_name }}
      package_file: ${{ steps.build.outputs.package_file }}
    
    steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: Build solution
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ../Examples/Releases/*.nupkg
        retention-days: 7

  # =================== –®–ê–ì 2: –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –í NUGET.ORG ===================
  publish-to-nuget:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: build-and-pack

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Publish to NuGet.org
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        echo "Publishing packages to NuGet.org..."
        
        # –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–∫–µ—Ç (–±–µ–∑ symbols)
        PACKAGE_FILE=$(ls *.nupkg | grep -v symbols | head -1)
        
        if [ -z "$PACKAGE_FILE" ]; then
          echo "ERROR: No package file found!"
          exit 1
        fi
        
        echo "Publishing: $PACKAGE_FILE"
        echo "Version: ${{ needs.build-and-pack.outputs.package_version }}"
        
        # –ü—É–±–ª–∏–∫—É–µ–º –ø–∞–∫–µ—Ç
        dotnet nuget push "$PACKAGE_FILE" \
          --source "${{ env.NUGET_SOURCE }}" \
          --api-key "$NUGET_API_KEY" \
          --skip-duplicate \
          --timeout 300
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Successfully published to NuGet.org"
          echo "üì¶ Package URL: https://www.nuget.org/packages/${{ needs.build-and-pack.outputs.package_name }}/"
          
          # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ –≤ GitHub
          echo "Creating GitHub Release..."
        else
          echo "‚ùå Failed to publish to NuGet.org"
          exit 1
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        name: Release ${{ github.ref_name }}
        tag_name: ${{ github.ref_name }}
        generate_release_notes: true
        files: |
          *.nupkg